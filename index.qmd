---
title: "Belay, a flexible MicroPython interface for experimental hardware control"
authors: 
  - name: Mikkel Roald-Arb√∏l
    orcid: 0000-0003-2550-0012
    email: "science@roald-arboel.com"
    url: "https://roald-arboel.com"
    affiliations: 
      - name: University of Bonn
        department: Department of Biology
        city: Bonn
        postal-code: 53115
  - name: Brian Pugh
abstract: |
  Behavioural experiments often require specific hardware. Recent years have seen the increased availability of consumer-grade electronics which has led to increased adoption in experimental research. However, interfacing with microcontrollers has remained difficult. Here, we present Belay, a Python package that provides an accessible interface to with microcontrollers running Micropython. We compare it to existing libraries and solutions. We also show that performance remains good in terms of latency. We also show the versatility of using Belay, by showcasing its use from Python scripts, Jupyter Notebooks and within the visual reactive programming language Bonsai.
acknowledgments: |
  I would like to thank a lot of people.
license:
  id: CC-BY-4.0
  name: CC-BY-4.0
  url: https://creativecommons.org/licenses/by/4.0/
github: https://github.com/brianpugh/belay
open_access: true
keywords:
  - Software
  - Hardware
  - Micropython
  - Experimental control
bibliography: references.bib
---

## Introduction

Behavioural experiments often require specific hardware. Recent years have seen the increased availability of consumer-grade electronics which has led to increased adoption in experimental research. However, interfacing with microcontrollers has remained difficult. Here, we present Belay, a Python package that provides an accessible interface to with microcontrollers running Micropython [@zotero-6191]. We compare it to existing libraries and solutions. We also show that performance remains good in terms of latency. We also show the versatility of using Belay, by showcasing its use from Python scripts, Jupyter Notebooks and within the visual reactive programming language Bonsai [@Lopes2015].

LabNet [@Schatz2022], Autopilot [@Saunders2022], Bpod [@zotero-item-7401], Stytra [@Stih2019], ArControl [@Chen2017b]

Use of Python in neuroscience [@Muller2015a], Micropython arguably best language [@Maning2023].

## Results

### Flexibility
- MicroPython, CircuitPython
- Python, Jupyter Notebook, Bonsai
- MicroPython: Pyboard, ESP32, ESP8266, Raspberry Pi Pico, BBC micro:bit, STM32 development boards, and a few Arduino boards such as the Nano 33 BLE, Nano RP2040, Giga R1, and Portenta H7
- CircuitPython: [list of supported boards](https://circuitpython.org/downloads)

- Table over different software interfaces:
  - Microcontroller vs. single-board computer
  - Limited to specific hardware
  - Arduino vs. MicroPython/CircuitPython
  - Python interface
  - Integration with Bonsai
  - Connectivity (serial/wired, WiFi, Bluetooth, radio)

### Package capabilities

- Package manager

::: {#lst-import}
```{.python}
import belay
```
Import Belay
:::

::: {#lst-class}
```{.python}
from belay import Device

class Pico(Device):
    @Device.setup(autoinit=True)
    def setup():
        # Init on-board stuff
        led = Pin('LED', Pin.OUT)
        led.value(True)
        temperature = None
        
    @Device.task
    def _measure_temperature():
        temperature = 72.5  # Or read from a sensor
        return temperature

    def measure_temperature(self):
        # Runs on your computer - this is a regular method
        self._temperature = self._measure_temperature()
        return self._temperature

    @property
    def latest_temperature(self):
        # Now you can just return the cached value
        return self._temperature
```
Create class
:::

Writing something about subclassing (@lst-class).

### Integration with Bonsai
Bonsai [@Lopes2015], BonVision [@Lopes2021], real-time tracking using DeepLabCut [@Mathis2018; @Kane2020a] and SLEAP [@Pereira2022].


### Performance

- Set/ping test
- Read and set GPIO
- Stress test

### Examples

## Discussion

This work showcases the utility of Belay, a Python package for powerful control of Micropython-based microcontrollers. Belay is a general-purpose package, which makes it a powerful tool for experimental science broadly. The fact that it can be used in standard Python scripts, interactively in Jupyter Notebooks or in Bonsai workflows highlights the versatility.

Because of it being open-source and general-purpose, the community around it entails many more users than just those engaged in research, leading to a larger community with greater knowledge sharing.

@Pearce2017, @Pearce2020, @Chagas2017a

## Materials & Methods

## Data availability